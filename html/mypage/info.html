<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I CHAT U | MYPAGE INFO</title>

        <!-- CSS -->
        <link rel="shortcut icon" href="/image/favicon.ico">
        <link href="/css/common/reset.css" rel="stylesheet" type="text/css">
        <link href="/css/common/common.css" rel="stylesheet" type="text/css">
        <link href="/css/common/header.css" rel="stylesheet" type="text/css">
        <link href="/css/common/modal.css" rel="stylesheet" type="text/css">
        <link href="/css/common/aside.css" rel="stylesheet" type="text/css">
        <link href="/css/mypage/info.css" rel="stylesheet" type="text/css">
    
        <!-- Axios -->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <!-- Firebase (Not FIREBASE Hosting)-->
        <script src="https://www.gstatic.com/firebasejs/8.9.0/firebase.js"></script>
        <!-- <script src="https://www.gstatic.com/firebasejs/8.9.0/firebase-app.js"></script> -->
        <script src="https://www.gstatic.com/firebasejs/8.9.0/firebase-messaging.js"></script>
        <!-- Snipet -->
        <script type="module" defer src="/js/common/snipet.js"></script>
        <!-- JS -->
        <script src="/js/common/data.js"></script>
        <script src="/js/common/footer.js"></script>
        <script src="/js/common/store.js"></script>
        <script defer src="/js/common/modal.js"></script>

</head>
<body>
    <header id="header">
        <!-- Logo -->
        <div class="hd-first-box">
            <a href="/chat/rooms" class="hd-link">
                <img src="/image/header/logo.png" class="hd-logo">
            </a>
            <!-- Search Bar -->
            <!-- <div class="hd-search-box">
                <input id="hd-search" type="text" class="hd-search-bar" placeholder="Search...">
                <label for="hd-search" class="hd-btn-search">검색</span>
            </div> -->
        </div>
        <!-- 로그인 X -->
        <div class="hd-button-box">
            <span class="hd-btn-login">LOGIN</span>
            <span class="hd-btn-signup">SIGN UP</span>
        </div>
        <!-- 로그인 O -->
        <div class="icon-box">
            
            <!-- Profile -->
            <div class="profile-box">
                <button class="hd-profile">프로필</button>
                <div class="hd-profile-content hide">
                    <!-- 프로필 간단 내역 -->
                    <div class="hd-profile-icon-box">
                        <img class="hd-profile-icon" src="/image/common/user.png">
                    </div>
                    <div class="hd-profile-last-login">
                        마지막 로그인 : 방금 전
                    </div>
                    <div class="hd-profile-nickname">
                        gorany
                    </div>
                    <!-- 마이페이지 가기 -->
                    <div class="hd-profile-to-mypage hd-profile-text">
                        Mypage
                    </div>
                    <!-- 로그아웃 -->
                    <div class="hd-profile-to-logout hd-profile-text">
                        Logout
                    </div>
                </div>
            </div>

            <!-- Notification Bell -->
            <div class="bell-box">
                <span class="bell bell-off"></span>
                <div class="toast toast-off"></div>
                <div class="hide notification-box">

                    <div class="top">
                        <button class="btn-remove-all">확인된 알람 지우기</button>
                        <button class="btn-check-all">전체 확인</button>
                    </div>

                    <div class="notifications scroll-custom">

                    </div>

                    <div class="bottom">
                        <span class="btn-nt-more"></span>
                    </div>
                </div>
            </div>
            
            <!-- Menu -->
            <div>
                <button class="hd-menu">메뉴</button>
            </div>
        </div>
    </header>
    <div class="core-container">
        <aside id="aside">

            <div class="as-my-rooms">
                <div class="my-title">
                    MY ROOMS
                </div>

                <div class="my-rooms">

                    <div data-rid="-1" class="my-room">

                        <img src="/image/common/profile.png" class="my-room-profile">
                            
                        <div class="my-room-info">
                            <div class="top-box as-top-box">
                                <div class="my-room-name">
                                    <a href="room?id=-1">SAMPLE TITLE</a>
                                </div>
                                <div class="my-room-chat">
                                    Hello Sample
                                </div>
                            </div>
                        </div>

                        <div class="my-room-count">
                            9+
                        </div>
                    </div>

                </div>
            </div>

        </aside>
        <!-- MAIN & ASIDE -->
        <main id="main">
            
            <div class="mp-box">

                <!-- Profile 폼데이터 Click -> 미리보기 -> 저장Click -> 저장 -->
                <div class="mp-profile-box">
                    <label for="mp-profile-input" class="mp-profile"></label>
                    <input class="hide" accept="image/*" type="file" id="mp-profile-input">
                </div>

                <!-- Nickname (Immutable) -->
                <div class="mp-nickname-box">
                    <label for="mp-nickname-input">닉네임</label>
                    <div id="mp-nickname-input"></div>
                </div>

                <!-- E-mail -->
                <div class="mp-email-box">
                    <label for="mp-email-input">E-mail</label>
                    <input type="text" id="mp-email-input">
                </div>

                <!-- Password -->
                <div class="mp-password-box">
                    <button class="btn-password-update">비밀번호 변경</button>
                    <!-- Modal 띄워서 처리? -->
                </div>

                <button class="btn-update">회원 정보 변경</button>

                <div class="member-drop-box">
                    <div class="top-box">
                        <div class="member-drop-text">
                            회원 탈퇴
                        </div>
                        <div class="member-drop-arrow">
                            >
                        </div>
                    </div>

                    <div class="bottom-box hide">
                        <div class="survey-list">
                            <div class="survey-item">
                                <div class="survey-title">Q. 탈퇴하시는 이유를 알려주세요.</div>

                                <div class="item-list">
                                    <div class="item">
                                        <input name="first-item" type="radio" value="1" checked>사용할 일이 많지 않아서
                                    </div>
                                    <div class="item">
                                        <input name="first-item" type="radio" value="2">서비스가 마음에 들지 않아서
                                    </div>
                                    <div class="item">
                                        <input name="first-item" type="radio" value="3">기타
                                    </div>
                                </div>
                            </div>
                            <div class="survey-item">
                                <div class="survey-title">Q. 만족도는 어땠나요?</div>

                                <div class="item-list">
                                    <div class="item">
                                        <input name="second-item" type="radio" value="1" checked>좋아요
                                    </div>
                                    <div class="item">
                                        <input name="second-item" type="radio" value="1">보통이에요
                                    </div>
                                    <div class="item">
                                        <input name="second-item" type="radio" value="1">별로에요
                                    </div>
                                </div>
                            </div>
                        </ul>
                        
                        <div class="drop-check-box">
                            <input type="password" id="drop-check-password" placeholder="비밀번호를 입력해주세요.">
                        </div>

                        <button class="btn-member-drop">탈퇴</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
    window.addEventListener('load', () => {

        const mpBox = document.querySelector('.mp-box');
        const mpProfileBox = mpBox.querySelector('.mp-profile-box');
        const mpProfile = mpBox.querySelector('.mp-profile');
        const mpProfileInput = mpBox.querySelector('#mp-profile-input');
        const mpNicknameInput = mpBox.querySelector('#mp-nickname-input');
        const mpEmailInput = mpBox.querySelector('#mp-email-input');
        const btnUpdate = mpBox.querySelector('.btn-update');

        const btnPasswordUpdate = mpBox.querySelector('.btn-password-update');
        const btnMemberDrop = mpBox.querySelector('.btn-member-drop');
        const dropCheckPassword = mpBox.querySelector('#drop-check-password');
        const firstItem = mpBox.querySelector('input[name="first-item"');
        const secondItem = mpBox.querySelector('input[name="second-item"');

        const memberDropArrow = mpBox.querySelector('.member-drop-arrow');
        const bottomBox = mpBox.querySelector('.bottom-box');

        /* MODAL */
        const oldPassword = modalCanvas.querySelector('#old-password');
        const newPassword = modalCanvas.querySelector('#new-password');
        const modalBtnUpdate = modalCanvas.querySelector('.modal-btn-update');

        var formData = null;

        /* 기존 등록된 프로필 이미지가 있으면 그것으로 출력 */
        (() => {
            if(sessionProfileId != 'null'){
                const src = `${sessionProfilePath}/${sessionProfileId}_${sessionProfileName}`;

                mpProfile.style.backgroundImage = `url("/upload${src}")`;
            }
        })();

        /* 내 정보 조회 */
        (async () => {

            const data = await axios({
                url: `${origin}/api/v1/members/${sessionMemberId}`,
                method: `GET`
            })
            .then(response => response.data);

            mpNicknameInput.innerText = data.nickname;
            mpEmailInput.value = data.email;

            })();

        /* Profile 이미지 onChange */
        mpProfileInput.addEventListener('change', function (e) {

            const file = this.files[0];
            
            handleFiles(file);

            formData = new FormData();
            formData.append("file", file);
            console.log(formData.get('file').name);
        });

        /* 이미지 미리보기 */
        function handleFiles(file) {
            
            if (!file.type.startsWith('image/')) {
                alert('이미지만 올리세요~');
                return;
            }

            const reader = new FileReader();
            
            reader.addEventListener('load', (e) => {
                mpProfile.style.backgroundImage = `url("${e.target.result}")`;
            });

            reader.readAsDataURL(file); 
        };

        /* 회원 정보 변경 버튼 CLICK */
        btnUpdate.addEventListener('click', async (e) => {

            const nickname = mpNicknameInput.value;
            const email = mpEmailInput.value;
            const profileId = null;

            if(formData){
                profileId = await axios({
                    url: `/mypage/upload`,
                    method: 'POST',
                    data: formData
                })
                .then(resp => resp.data);
            }

            //console.log(profileId.data);

            const datas = {
                name: formData? formData.get('file').name : null,
                profileId: profileId? profileId.data : null,
                id: sessionMemberId,
                nickname: nickname,
                email: email,
                path: getPath()
            };

            /* request to API SERVER for DB */
            await axios({
                url: `${origin}/api/v1/members/info`,
                method: 'PUT',
                headers: {'content-type' : 'application/json'},
                data: datas
            })
            .then(response => response.data)
            .then(data => {
                
                if(data != null){
                    sessionStorage.setItem('profileId', datas.profileId);
                    sessionStorage.setItem('profileName', datas.name);
                    sessionStorage.setItem('profilePath', datas.path);
                }
                location.reload();
            })
            .catch(err => console.log('Exception Occured : ', err));
        });

        function getPath(){
            const date = new Date();    

            const year = date.getFullYear();
            const month = date.getMonth();

            return `/${year}/${month + 1}`;
        }
        
        /* 비밀번호 변경 REQUEST */
        modalBtnUpdate.addEventListener('click', async (e) => {

            const oldPasswordValue = oldPassword.value;
            const newPasswordValue = newPassword.value;

            /* Validation */
            if(newPasswordValue.length < 6 || newPasswordValue.length > 12){
                alert('비밀번호를 최소 6자, 최대 12자에 맞게 입력해주세요.');
                modalCanvas.classList.toggle('hide');

                return;
            }

            const result = await axios({
                url: `${origin}/api/v1/members/password`,
                method: 'PATCH',
                headers: {'Content-type':'application/json'},
                data: {
                    id: sessionMemberId,
                    oldPassword: oldPasswordValue,
                    newPassword: newPasswordValue
                }
            })
            .then(response => response.data)
            .then(data => alert('비밀번호가 변경되었습니다.'))
            .catch(err => alert('비밀번호 변경에 실패하였습니다. 비밀번호를 확인해주세요. '));

            modalCanvas.classList.toggle('hide');
        });

        /* 회원탈퇴 박스 CLICK */
        memberDropArrow.addEventListener('click', (e) => {
            bottomBox.classList.toggle('hide');
        });
        /* 회원탈퇴 */
        btnMemberDrop.addEventListener('click', (e) => {
            e.preventDefault();

            axios({
                url: `${origin}/api/v1/members/drop`,
                method: 'DELETE',
                headers: {'Content-type': 'application/json'},
                data: {
                    id: sessionMemberId,
                    password: dropCheckPassword.value,
                    first: firstItem.value,
                    second: secondItem.value
                }
            })
            .then(response => response.data)
            .then(data => {
                if(data === 'success'){
                    sessionStorage.clear();
                    location = '/login';
                }
                
            })
            .catch(err => alert('회원 탈퇴 실패'));
        });

        /* 비밀번호 변경 버튼 CLICK */
        btnPasswordUpdate.addEventListener('click', (e) => {

            newPassword.value = '';
            oldPassword.value = '';
            modalCanvas.classList.toggle('hide');
        });
    });
</script>

<footer id="footer">
    <div class="ft-link-box">
        <!-- Blog -->
        <span class="ft-blog" title="Blog">blog</span>
        <span style="font-size: 13px;text-align: center;line-height: 24px;">|</span>
        <!-- Github -->
        <span class="ft-github" title="Github">github</span>
        <!-- ? -->
    </div>
    <div class="ft-info-box">
        <div class="ft-info">
            <div>대표자 : 김지호</div>
            <div>이메일: jiho519@naver.com</div>
            <div>주소: 서울시 도봉구 노해로 372 foo층</div>
        </div>
        <div class="ft-right">
            ©I CHAT U. ALL RIGHTS RESERVED
        </div>
    </div>
</footer>

<!-- Modal -->
<div class="modal-canvas w-100 h-100 hide">

    <div class="modal w-100 h-40">
        <div class="modal-hd">
            <div class="modal-title">
                PASSWORD UPDATE
            </div>
        </div>
    
        <div class="modal-body">
            <div class="modal-body-content">
                <div class="body-text">
                    현재 비밀번호를 입력해주세요.
                </div>
                <div class="body-content">
                    <input type="password" name="old-password" id="old-password" placeholder="현재 비밀번호">
                </div>

                <div class="body-text">
                    변경하실 비밀번호를 입력해주세요. (6글자 ~ 12글자)
                </div>
                <div class="body-content">
                    <input type="password" name="new-password" id="new-password" placeholder="새 비밀번호">
                </div>
            </div>
        </div>
    
        <div class="modal-ft">
            <button class="modal-btn-update">UPDATE</button>
            <button class="modal-btn-cancel">CANCEL</button>
        </div>
    </div>

</div>
</body>
</html>