<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I CHAT U | MYPAGE INFO</title>

        <!-- CSS -->
        <link rel="shortcut icon" href="/image/favicon.ico">
        <link href="/css/common/reset.css" rel="stylesheet" type="text/css">
        <link href="/css/common/common.css" rel="stylesheet" type="text/css">
        <link href="/css/common/header.css" rel="stylesheet" type="text/css">
        <link href="/css/common/modal.css" rel="stylesheet" type="text/css">
        <link href="/css/mypage/info.css" rel="stylesheet" type="text/css">
    
        <!-- Axios -->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <!-- Firebase (Not FIREBASE Hosting)-->
        <script src="https://www.gstatic.com/firebasejs/8.9.0/firebase.js"></script>
        <!-- <script src="https://www.gstatic.com/firebasejs/8.9.0/firebase-app.js"></script> -->
        <script src="https://www.gstatic.com/firebasejs/8.9.0/firebase-messaging.js"></script>
        <!-- Snipet -->
        <script type="module" defer src="/js/common/snipet.js"></script>
        <!-- JS -->
        <script src="/js/common/data.js"></script>
        <script src="/js/common/footer.js"></script>
        <script src="/js/common/store.js"></script>
        <script defer src="/js/common/modal.js"></script>

</head>
<body>
    <header id="header">
        <!-- Logo -->
        <div class="hd-first-box">
            <a href="/chat/rooms" class="hd-link">
                <img src="/image/header/logo.png" class="hd-logo">
            </a>
            <!-- Search Bar -->
            <!-- <div class="hd-search-box">
                <input id="hd-search" type="text" class="hd-search-bar" placeholder="Search...">
                <label for="hd-search" class="hd-btn-search">검색</span>
            </div> -->
        </div>
        <!-- 로그인 X -->
        <div class="hd-button-box">
            <span class="hd-btn-login">LOGIN</span>
            <span class="hd-btn-signup">SIGN UP</span>
        </div>
        <!-- 로그인 O -->
        <div class="icon-box">
            
            <!-- Profile -->
            <div class="profile-box">
                <button class="hd-profile">프로필</button>
                <div class="hd-profile-content hide">
                    <!-- 프로필 간단 내역 -->

                    <!-- 마이페이지 가기 -->

                    <!-- 로그아웃 -->
                </div>
            </div>

            <!-- Notification Bell -->
            <div class="bell-box">
                <span class="bell bell-off"></span>
                <div class="toast toast-off"></div>
                <div class="hide notification-box">

                    <div class="top">
                        <button class="btn-remove-all">확인된 알람 지우기</button>
                        <button class="btn-check-all">전체 확인</button>
                    </div>

                    <div class="notifications scroll-custom">

                    </div>

                    <div class="bottom">
                        <span class="btn-nt-more"></span>
                    </div>
                </div>
            </div>
            
            <!-- Menu -->
            <div>
                <button class="hd-menu">메뉴</button>
            </div>
        </div>
    </header>
    <div class="core-container">
        <aside id="aside">

        </aside>
        <!-- MAIN & ASIDE -->
        <main id="main">
            
            <div class="mp-box">

                <!-- Profile 폼데이터 Click -> 미리보기 -> 저장Click -> 저장 -->
                <div class="mp-profile-box">
                    <label for="mp-profile-input" class="mp-profile"></label>
                    <input class="hide" accept="image/*" type="file" id="mp-profile-input">
                </div>

                <!-- Nickname -->
                <div class="mp-nickname-box">
                    <label for="mp-nickname-input">닉네임</label>
                    <input type="text" id="mp-nickname-input">
                </div>

                <!-- E-mail -->
                <div class="mp-email-box">
                    <label for="mp-email-input">E-mail</label>
                    <input type="text" id="mp-email-input">
                </div>

                <!-- Password -->
                <div class="mp-password-box">
                    <button>비밀번호 변경</button>
                    <!-- Modal 띄워서 처리? -->
                </div>

                <button class="btn-update">회원 정보 변경</button>
            </div>

        </main>
    </div>

<script>
    window.addEventListener('load', () => {

        const origin = `http://localhost:8080`;
        //const origin = 'https://ichatu.ga';

        const mpBox = document.querySelector('.mp-box');
        const mpProfileBox = mpBox.querySelector('.mp-profile-box');
        const mpProfile = mpBox.querySelector('.mp-profile');
        const mpProfileInput = mpBox.querySelector('#mp-profile-input');
        const mpNicknameInput = mpBox.querySelector('#mp-nickname-input');
        const mpEmailInput = mpBox.querySelector('#mp-email-input');
        const btnUpdate = mpBox.querySelector('.btn-update');

        var formData = null;

        /* 기존 등록된 프로필 이미지가 있으면 그것으로 출력 */
        (() => {
            if(sessionProfileId){
                const src = `${sessionProfilePath}/${sessionProfileId}_${sessionProfileName}`;

                mpProfile.style.backgroundImage = `url("/upload${src}")`;
            }
        })();

        /* Profile 이미지 onChange */
        mpProfileInput.addEventListener('change', function (e) {

            const file = this.files[0];
            
            handleFiles(file);

            formData = new FormData();
            formData.append("file", file);
            console.log(formData.get('file').name);
        });

        /* 이미지 미리보기 */
        function handleFiles(file) {
            
            if (!file.type.startsWith('image/')) {
                alert('이미지만 올리세요~');
                return;
            }

            const reader = new FileReader();
            
            reader.addEventListener('load', (e) => {
                mpProfile.style.backgroundImage = `url("${e.target.result}")`;
            });

            reader.readAsDataURL(file); 
        };

        /* 회원 정보 변경 버튼 CLICK */
        btnUpdate.addEventListener('click', async (e) => {

            const nickname = mpNicknameInput.value;
            const email = mpEmailInput.value;

            const profileId = await axios({
                url: `/mypage/upload`,
                method: 'POST',
                data: formData
            })
            .then(resp => resp.data);

            console.log(profileId.data);

            const datas = {
                name: formData.get('file').name,
                profileId: profileId.data,
                id: sessionMemberId,
                nickname: nickname,
                email: email,
                path: getPath()
            };

            /* request to API SERVER for DB */
            await axios({
                url: `${origin}/api/v1/members/info`,
                method: 'PUT',
                headers: {'content-type' : 'application/json'},
                data: datas
            })
            .then(response => response.data)
            .then(data => {
                if(data != null){
                    sessionStorage.setItem('profileId', datas.profileId);
                    sessionStorage.setItem('profileName', datas.name);
                    sessionStorage.setItem('profilePath', datas.path);

                    location.reload();
                }
            })
            .catch(err => console.log('Exception Occured : ', err));
        });

        function getPath(){
            const date = new Date();    

            const year = date.getFullYear();
            const month = date.getMonth();

            return `/${year}/${month + 1}`;
        }
        
    });
</script>

<footer id="footer">
    <div class="ft-link-box">
        <!-- Blog -->
        <span class="ft-blog" title="Blog">blog</span>
        <span style="font-size: 13px;text-align: center;line-height: 24px;">|</span>
        <!-- Github -->
        <span class="ft-github" title="Github">github</span>
        <!-- ? -->
    </div>
    <div class="ft-info-box">
        <div class="ft-info">
            <div>대표자 : 김지호</div>
            <div>이메일: jiho519@naver.com</div>
            <div>주소: 서울시 도봉구 노해로 372 foo층</div>
        </div>
        <div class="ft-right">
            ©I CHAT U. ALL RIGHTS RESERVED
        </div>
    </div>
</footer>

<!-- Modal -->
<div class="modal-canvas w-100 h-100 hide">

    <div class="modal w-100 h-40">
        <div class="modal-hd">
            <div class="modal-title">
                CHAT ROOM DROP
            </div>
        </div>
    
        <div class="modal-body">
            채팅방을 탈퇴하시겠습니까?
        </div>
    
        <div class="modal-ft">
            <button class="modal-btn-register">REGISTER</button>
            <button class="modal-btn-drop">DROP</button>
            <button class="modal-btn-cancel">CANCEL</button>
        </div>
    </div>

</div>
</body>
</html>